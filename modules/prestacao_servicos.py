import streamlit as st
import pandas as pd
from components.importacao import *

def _ajuda_pill(conteudo_md: str, titulo: str = "Ajuda"):
    """
    Renderiza um pequeno bot√£o/pill de ajuda logo ap√≥s o label.
    Usa st.popover se dispon√≠vel; fallback para expander compacto.
    """
    if hasattr(st, "popover"):
        with st.popover("‚ùì", use_container_width=False):
            st.markdown(conteudo_md)
    else:
        with st.expander(f"‚ùì {titulo}"):
            st.markdown(conteudo_md)

def uploader_com_ajuda(label: str, tipos, chave: str, ajuda_md: str):
    """
    Mostra o label + pill de ajuda na MESMA linha e em seguida o componente de upload.
    """
    linha = st.columns([0.7, 0.3])
    with linha[0]:
        st.markdown(f"**{label}**", help=None)
    with linha[1]:
        _ajuda_pill(ajuda_md)
    return st.file_uploader(label, type=tipos, key=chave, label_visibility="collapsed")


AJUDA_CLINICA = """**Sistema:** WorkLab
**Caminho:** Cl√≠nica ‚ûú Atendimento por Data
**Par√¢metros:** Data do dia anterior
**Instru√ß√µes:** Gerar Excel ‚ûú Excel Resumido
**Nome padr√£o:** relConsultaData(-data-).xlsx"""
AJUDA_LAB = """**Sistema:** WorkLab
**Caminho:** Relat√≥rios ‚ûú Movimento Di√°rio
**Par√¢metros:** Data do dia anterior
**Instru√ß√µes:** Pesquisar ‚ûú Bot√£o Excel ‚ûú Gerar Excel Detalhado
**Nome padr√£o:** relMovimentoDiarioDetalhado(-data-).xls"""
AJUDA_CONVENIO_DETALHADO = """**Sistema:** WorkLab
**Caminho:** Relat√≥rios ‚ûú Conv√™nio ‚ûú Por Conv√™nio Individual 
**Par√¢metros:** M√™s anterior
**Instru√ß√µes:** Preencher par√¢metros ‚ûú Gerar Excel ‚ûú Detalhado por Linha
**Nome padr√£o:** relConvDetalhadoPorLinha_(-data-).xlsx"""
AJUDA_IPES = """**Sistema:** https://portalconectasaude.com.br
**Caminho:** Extrato de Utiliza√ß√£o
**Par√¢metros:** M√™s anterior; Situa√ß√£o: Autorizada, Autorizada parcialmente, Autorizada em Conting√™ncia
**Instru√ß√µes:** Preencher par√¢metros ‚ûú Emitir
**Nome padr√£o:** relat_utilizacao(-data-).pdf"""
AJUDA_MULVI = """**Sistema:** https://app.mulvipay.com.br
**Caminho:** Movimenta√ß√µes ‚ûú Movimenta√ß√£o Financeira
**Par√¢metros:** Data do dia anterior
**Instru√ß√µes:** Consultar ‚ûú Anal√≠tico ‚ûú Baixar Relat√≥rio em Excel
**Nome padr√£o:** MovimentoFinanceiro41416978000116_(-data-).xlsx"""
AJUDA_GETNET = """**Sistema:** https://minhaconta.getnet.com.br
**Caminho:** Financeiro ‚ûú Recebimentos ‚ûú Baixar extrato
**Par√¢metros:** Dia anterior; Apresenta√ß√£o: Detalhado
**Instru√ß√µes:** Financeiro ‚ûú Recebimentos ‚ûú Baixar extrato ‚ûú Per√≠odo personalizado (dia anterior) ‚ûú Apresenta√ß√£o: Detalhado ‚ûú Formato: Excel ‚ûú Baixar
**Nome padr√£o:** Recebivel_Completos_(...).xlsx"""


def show():
    """P√°gina de Importa√ß√µes - antiga presta√ß√£o de servi√ßos."""
    st.header("üìÇ Importa√ß√µes")
    st.markdown("**Importa√ß√£o de arquivos para o sistema da cl√≠nica.**")
    # Upload de arquivos
    st.markdown("##### üìÅ Upload de Arquivos")
    
    col1, col2 = st.columns(2)

    with col1:
        arquivo_clinica = uploader_com_ajuda(
            "Arquivo da Cl√≠nica (XLS/XLSX)",
            ['xls','xlsx'],
            f"arquivo_clinica_{st.session_state.get('upload_counter', 0)}",
            AJUDA_CLINICA
        )
        arquivo_laboratorio = uploader_com_ajuda(
            "Arquivo do Laborat√≥rio (XLS/XLSX)",
            ['xls','xlsx'],
            f"arquivo_laboratorio_{st.session_state.get('upload_counter', 0)}",
            AJUDA_LAB
        )
        arquivo_convenio_detalhado = uploader_com_ajuda(
            "Arquivo de Conv√™nio Detalhado (XLSX)",
            ['xlsx','xls'],
            f"arquivo_convenio_detalhado_{st.session_state.get('upload_counter', 0)}",
            AJUDA_CONVENIO_DETALHADO
        )

    with col2:
        arquivo_convenio_pdf = uploader_com_ajuda(
            "Arquivo de Conv√™nio IPES (PDF)",
            ['pdf'],
            f"arquivo_convenio_pdf_{st.session_state.get('upload_counter', 0)}",
            AJUDA_IPES
        )
        arquivo_mulvi = uploader_com_ajuda(
            "Arquivo MULVI (XLSX)",
            ['xlsx','xls'],
            f"arquivo_mulvi_{st.session_state.get('upload_counter', 0)}",
            AJUDA_MULVI
        )
        arquivo_getnet = uploader_com_ajuda(
            "Cart√£o GETNET Detalhado (XLSX)",
            ['xlsx','xls'],
            f"arquivo_getnet_{st.session_state.get('upload_counter', 0)}",
            AJUDA_GETNET
        )

    
    # Bot√£o de processamento
    st.markdown("---")
    if st.button("üîÑ Processar Arquivos", use_container_width=True):
        if any([arquivo_clinica, arquivo_laboratorio, arquivo_convenio_detalhado,arquivo_convenio_pdf, arquivo_mulvi, arquivo_getnet]):
            with st.spinner("Processando arquivos..."):
                resultado = processar_arquivos(arquivo_clinica, arquivo_laboratorio, arquivo_convenio_detalhado, arquivo_convenio_pdf, arquivo_mulvi, arquivo_getnet)

                if resultado['sucesso']:
                    st.success("Arquivos processados. Verifique os resultados abaixo.")
                    
                    # Popula os dados processados na sess√£o
                    dados_processados = {}
                    if resultado.get('dados_clinica') is not None:
                        dados_processados['clinica'] = resultado['dados_clinica']
                    if resultado.get('dados_laboratorio') is not None:
                        dados_processados['laboratorio'] = resultado['dados_laboratorio']
                    if resultado.get('dados_convenio_detalhado') is not None:
                        dados_processados['convenio_detalhado'] = resultado['dados_convenio_detalhado']
                    if resultado.get('dados_convenios') is not None:
                        dados_processados['convenio_ipes'] = resultado['dados_convenios']
                    if resultado.get('dados_mulvi') is not None:
                        dados_processados['mulvi'] = resultado['dados_mulvi']
                    if resultado.get('dados_getnet') is not None:
                        dados_processados['credito_getnet'] = resultado['dados_getnet']
                    
                    st.session_state.dados_processados = dados_processados
                                        
                    st.session_state.conflitos_data = resultado.get('conflitos', {})
                    
                    st.rerun() # For√ßa a re-renderiza√ß√£o para mostrar os resultados e a mensagem de conflito
                else:
                    st.error(f"Erro no processamento: {resultado.get('erro', 'Erro desconhecido')}")
        else:
            st.warning("Por favor, envie pelo menos um arquivo.")

    # Se√ß√£o de confirma√ß√£o e salvamento
    if 'dados_processados' in st.session_state:
        st.markdown("---")
        st.markdown("### üíæ Confirma√ß√£o da Importa√ß√£o")

        conflitos = st.session_state.get('conflitos_data', {})
        
        # CASO 1: N√ÉO H√Å CONFLITOS
        if not conflitos:
            st.info("‚úÖ Nenhuma data conflitante encontrada. Voc√™ pode realizar a importa√ß√£o.")
            if st.button("üî¥ Realizar Importa√ß√£o", type="primary", use_container_width=True):
                with st.spinner("Salvando dados..."):
                    df_clinica = st.session_state.dados_processados.get('clinica')
                    df_laboratorio = st.session_state.dados_processados.get('laboratorio')
                    df_convenio_detalhado = st.session_state.dados_processados.get('convenio_detalhado')
                    df_convenio_ipes = st.session_state.dados_processados.get('convenio_ipes')
                    df_mulvi = st.session_state.dados_processados.get('mulvi')
                    df_getnet = st.session_state.dados_processados.get('credito_getnet')
                    resultado_save = salvar_importacao(df_clinica, df_laboratorio, df_convenio_detalhado,
                                                       df_convenio_ipes, df_mulvi, df_getnet)

                    if resultado_save['sucesso']:
                        st.success("‚úÖ Dados importados com sucesso!")

                        # Mostra d√©bitos registrados automaticamente
                        if resultado_save.get('debitos_registrados', 0) > 0:
                            st.success(f"üí≥ {resultado_save['debitos_registrados']} pagamentos em d√©bito foram registrados automaticamente nas contas:")
                            st.info("‚Ä¢ D√©bito MULVI ‚Üí Conta BANESE\n‚Ä¢ D√©bito GETNET ‚Üí Conta SANTANDER")
                        
                        # NOVO: Mostra resultado da consolida√ß√£o IPES
                        consolidacao_ipes = resultado_save.get('consolidacao_ipes')
                        if consolidacao_ipes:
                            if consolidacao_ipes['sucesso']:
                                st.success(f"üè• IPES: {consolidacao_ipes['mensagem']}")
                            else:
                                st.warning(f"‚ö†Ô∏è IPES: {consolidacao_ipes['mensagem']}")
                                                
                        try:
                            sucesso_recebimentos, msg_recebimentos = atualizar_recebimentos_pendentes()
                            if sucesso_recebimentos:
                                st.success(f"üí∞ Recebimentos: {msg_recebimentos}")
                            else:
                                st.warning(f"‚ö†Ô∏è Recebimentos: {msg_recebimentos}")
                        except Exception as e:
                            st.warning(f"‚ö†Ô∏è Problema ao atualizar recebimentos: {str(e)}")
                        
                        st.markdown("### üìä Resumo da Importa√ß√£o")
                        col_res1, col_res2, col_res3, col_res4, col_res5, col_res6 = st.columns(6)
                        # ... (c√≥digo das m√©tricas, sem altera√ß√µes)
                        with col_res1:
                            if resultado_save.get('clinica_linhas', 0) > 0:
                                st.metric("Cl√≠nica", f"{resultado_save['clinica_linhas']} registros")
                        with col_res2:
                            if resultado_save.get('laboratorio_linhas', 0) > 0:
                                st.metric("Laborat√≥rio", f"{resultado_save['laboratorio_linhas']} registros")
                        with col_res3:
                            if resultado_save.get('convenio_detalhado_linhas', 0) > 0:
                                st.metric("Conv√™nio Detalhado", f"{resultado_save['convenio_detalhado_linhas']} registros")
                        with col_res4:
                            if resultado_save.get('ipes_linhas', 0) > 0:
                                st.metric("Conv√™nio IPES", f"{resultado_save['ipes_linhas']} registros")
                        with col_res5:
                            if resultado_save.get('mulvi_linhas', 0) > 0:
                                st.metric("MULVI", f"{resultado_save['mulvi_linhas']} registros")
                        with col_res6:
                            if resultado_save.get('getnet_linhas', 0) > 0:
                                st.metric("GETNET", f"{resultado_save['getnet_linhas']} registros")

                        del st.session_state.dados_processados
                        if 'conflitos_data' in st.session_state:
                            del st.session_state.conflitos_data
                        if 'upload_counter' not in st.session_state:
                            st.session_state.upload_counter = 0
                        st.session_state.upload_counter += 1
                        st.rerun()
                        
                    else:
                        st.error(f"‚ùå Erro ao salvar dados: {resultado_save['erro']}")
        
        # CASO 2: H√Å CONFLITOS (NOVO BLOCO ELSE)
        else:
            mensagens_erro = []
            for tipo, datas in conflitos.items():
                nome_amigavel = tipo.replace('_', ' ').title()
                datas_str = ", ".join(datas)
                mensagens_erro.append(f"**{nome_amigavel}** (Datas: {datas_str})")
            
            erro_final = (
                "‚ùå **Importa√ß√£o Bloqueada por Conflito de Datas.**\n\n"
                "Os seguintes arquivos cont√™m dados para datas que j√° existem no sistema:\n- " +
                "\n- ".join(mensagens_erro) +
                "\n\n**A√ß√£o Necess√°ria:** Cancele esta importa√ß√£o. Se desejar sobrescrever os dados, primeiro exclua os registros antigos na se√ß√£o 'Hist√≥rico de Atendimentos Importados' abaixo."
            )
            st.error(erro_final)

            if st.button("‚ùå Cancelar Importa√ß√£o", use_container_width=True):
                del st.session_state.dados_processados
                if 'conflitos_data' in st.session_state:
                    del st.session_state.conflitos_data
                st.rerun()

        # Visualiza√ß√£o dos dados processados (agora fora do if/else principal)
        st.markdown("---")
        st.markdown("### üìä Dados Processados (Pr√©-visualiza√ß√£o)")
        
        tab_names = []
        if st.session_state.dados_processados.get('clinica') is not None:
            tab_names.append("Cl√≠nica")
        if st.session_state.dados_processados.get('laboratorio') is not None:
            tab_names.append("Laborat√≥rio")
        if st.session_state.dados_processados.get('convenio_detalhado') is not None:
            tab_names.append("Conv√™nio Detalhado")
        if st.session_state.dados_processados.get('convenio_ipes') is not None:
            tab_names.append("Conv√™nio IPES")
        if st.session_state.dados_processados.get('mulvi') is not None:
            tab_names.append("MULVI")
        if st.session_state.dados_processados.get('credito_getnet') is not None:
            tab_names.append("GETNET")
            
        if tab_names:
            tabs = st.tabs(tab_names)
            tab_index = 0
            if st.session_state.dados_processados.get('clinica') is not None:
                with tabs[tab_index]:
                    df_clinica = st.session_state.dados_processados['clinica']
                    st.write(f"**Total de registros:** {len(df_clinica)}")
                    st.dataframe(df_clinica, use_container_width=True, hide_index=True)
                tab_index += 1
            if st.session_state.dados_processados.get('laboratorio') is not None:
                with tabs[tab_index]:
                    df_laboratorio = st.session_state.dados_processados['laboratorio']
                    st.write(f"**Total de registros:** {len(df_laboratorio)}")
                    st.dataframe(df_laboratorio, use_container_width=True, hide_index=True)
                tab_index += 1
            if st.session_state.dados_processados.get('convenio_detalhado') is not None:
                with tabs[tab_index]:
                    df_convenio_detalhado = st.session_state.dados_processados['convenio_detalhado']
                    st.write(f"**Total de registros:** {len(df_convenio_detalhado)}")
                    st.dataframe(df_convenio_detalhado, use_container_width=True, hide_index=True)
                tab_index += 1
            if st.session_state.dados_processados.get('convenio_ipes') is not None:
                with tabs[tab_index]:
                    df_convenio = st.session_state.dados_processados['convenio_ipes']
                    st.write(f"**Total de registros:** {len(df_convenio)}")
                    st.dataframe(df_convenio, use_container_width=True, hide_index=True)
                tab_index += 1
            if st.session_state.dados_processados.get('mulvi') is not None:
                with tabs[tab_index]:
                    df_mulvi = st.session_state.dados_processados['mulvi']
                    st.write(f"**Total de registros:** {len(df_mulvi)}")
                    st.dataframe(df_mulvi, use_container_width=True, hide_index=True)
                tab_index += 1
            if st.session_state.dados_processados.get('credito_getnet') is not None:
                with tabs[tab_index]:
                    df_getnet = st.session_state.dados_processados['credito_getnet']
                    st.write(f"**Total de registros:** {len(df_getnet)}")
                    st.dataframe(df_getnet, use_container_width=True, hide_index=True)
        else:
            st.info("Nenhum dado foi processado nos arquivos enviados.")

    # Se√ß√£o para visualizar dados importados (dados j√° salvos)
    st.markdown("---")
    st.markdown("### üìà Hist√≥rico de Atendimentos Importados")

    opcoes_map = {
        "Cl√≠nica": "clinica",
        "Laborat√≥rio": "laboratorio",
        "Conv√™nio Detalhado": "convenio_detalhado",
        "Conv√™nio IPES": "ipes",
        "Cart√£o MULVI": "mulvi",
        "Cart√£o GETNET": "getnet"
    }

    opcao_selecionada_nome = st.radio(
        "Selecione os dados para visualizar:",
        options=opcoes_map.keys(), # Mostra os nomes amig√°veis
        horizontal=True,
        key="vis_dados_salvos"
    )
    
    # Pega a chave interna correspondente ao nome selecionado
    opcao_visualizacao = opcoes_map[opcao_selecionada_nome]

    try:
        df_visualizacao = carregar_dados_atendimentos(opcao_visualizacao)
        
        if not df_visualizacao.empty:
            # Filtro por data - usar a coluna correta dependendo do tipo
            data_col = (
                'Data_Lan√ßamento' if opcao_visualizacao == 'mulvi'
                else 'DATA DE VENCIMENTO' if opcao_visualizacao == 'getnet'
                else 'data_cadastro'
            )
            
            if data_col in df_visualizacao.columns:
                df_viz_copy = df_visualizacao.copy()
                df_viz_copy[data_col] = pd.to_datetime(df_viz_copy[data_col]).dt.date
                
                data_min = df_viz_copy[data_col].min()
                data_max = df_viz_copy[data_col].max()
                
                col_data1, col_data2 = st.columns(2)
                with col_data1:
                    data_inicio = st.date_input(
                        "Data In√≠cio", value=data_min, min_value=data_min, 
                        max_value=data_max, key=f"data_inicio_{opcao_visualizacao}"
                    )
                with col_data2:
                    data_fim = st.date_input(
                        "Data Fim", value=data_max, min_value=data_min, 
                        max_value=data_max, key=f"data_fim_{opcao_visualizacao}"
                    )
                
                mask = (df_viz_copy[data_col] >= data_inicio) & (df_viz_copy[data_col] <= data_fim)
                df_filtrado = df_viz_copy[mask]
                
                st.markdown(f"**Registros no per√≠odo selecionado:** {len(df_filtrado)}")
                if not df_filtrado.empty:
                    st.dataframe(df_filtrado, use_container_width=True, hide_index=True)

                    # --- L√ìGICA DE EXCLUS√ÉO ---
                    st.markdown("---")
                    st.warning("**Aten√ß√£o:** A exclus√£o √© permanente e n√£o pode ser desfeita.")
                    
                    if st.button("üóëÔ∏è Excluir Registros do Per√≠odo Selecionado", key=f"delete_btn_{opcao_visualizacao}"):
                        st.session_state.confirm_delete = True
                        st.session_state.dates_to_delete = df_filtrado[data_col].unique().tolist()
                        st.session_state.type_to_delete = opcao_visualizacao

                    if st.session_state.get('confirm_delete') and st.session_state.get('type_to_delete') == opcao_visualizacao:
                        datas_str = ", ".join([d.strftime('%d/%m/%Y') for d in st.session_state.dates_to_delete])
                        if st.button(f"üî¥ CONFIRMAR EXCLUS√ÉO de {len(st.session_state.dates_to_delete)} dia(s)", type="primary"):
                            with st.spinner("Excluindo registros..."):
                                sucesso, msg = excluir_dados_por_data(
                                    st.session_state.type_to_delete, 
                                    st.session_state.dates_to_delete
                                )
                                if sucesso:
                                    st.success(msg)
                                else:
                                    st.error(msg)
                                
                                # Limpa o estado de confirma√ß√£o e recarrega a p√°gina
                                del st.session_state.confirm_delete
                                del st.session_state.dates_to_delete
                                del st.session_state.type_to_delete
                                st.rerun()

            else:
                st.dataframe(df_visualizacao, use_container_width=True, hide_index=True)
            
        else:
            st.info("üìù Nenhum dado encontrado. Fa√ßa a importa√ß√£o dos arquivos primeiro.")
            
    except Exception as e:
        st.error(f"Ocorreu um erro ao carregar o hist√≥rico: {e}")